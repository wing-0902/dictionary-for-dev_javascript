---
import SplitLayout from '../../layouts/SplitLayout.astro';
import licenseData from '../../data/license-data.json';

import fs from 'fs';
import path from 'path';

const licenseEntries = Object.entries(licenseData);

export async function getStaticPaths () {
  const licenseEntries = Object.entries(licenseData);
  return licenseEntries.map(([pkgName, pkgInfo]) => {
    let licenseContent = 'ライセンスファイルを取得できませんでした．'

    if (pkgInfo.licenseFile) {
      try {
        licenseContent = fs.readFileSync(pkgInfo.licenseFile, 'utf8');
      } catch (error) {
        console.error(`[Astro Build Error] ${pkgName} のライセンスファイルを読み込めませんでした: ${pkgInfo.licenseFile}`, error);
        licenseContent = `ライセンスファイル (${pkgInfo.licenseFile}) は見つかりませんでした。`;
      }
    }

    return {
      params: { 
        package: encodeURIComponent(pkgName)
      }, 
      props: { 
        packageData: pkgInfo, 
        packageName: pkgName,
        licenseContent: licenseContent,
      }, 
    };
  });
}

const { packageData, packageName, licenseContent } = Astro.props;
const nameOnly = packageName.split('@').slice(0, -1).join('@');
---

<SplitLayout
  title=`${packageName} - ライセンス`
  topbarTitle={nameOnly}
  leftComponent='ライセンス'
>
  <h1>{packageName}</h1>
  <p>このページは，ビルド時に{nameOnly}専用に生成されました．</p>

  <h2>ライセンス情報</h2>
  <ul>
    <li>{packageData.licenses} License</li>
    <li>リポジトリ：
      <a
        href={packageData.repository}
        target='_blank'
      >
        {packageData.repository}
      </a>
    </li>
    {packageData.publisher && <li>発行者：{packageData.publisher}</li>}
    {packageData.email && <li>電子メイル：<a href=`mailto:${packageData.email}` >{packageData.email}</a></li>}
    {packageData.url && <li>URL：<a href={packageData.url} target='_blank'>{packageData.url}</a></li>}
  </ul>

  {packageData.licenseFile &&
    <>
      <h2>ライセンスファイル情報</h2>
      <pre>
        <code>
          {licenseContent}
        </code>
      </pre>
    </>
  }
</SplitLayout>